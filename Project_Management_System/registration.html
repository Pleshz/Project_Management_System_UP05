<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Регистрация | Project Manager</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/style.css" />
</head>
<body class="auth-theme">
  <div class="auth-container">
    <div class="auth-card">
      <form class="auth-form" autocomplete="off" aria-label="Регистрация в Project Manager">
        <h1 class="auth-title">Регистрация</h1>
        <div class="input-group">
          <label for="register-login" class="input-label">Логин</label>
          <input
            type="text"
            id="register-login"
            name="register-login"
            class="input-field"
            placeholder="Придумайте логин"
            required
            aria-label="Логин"
            autocomplete="off"
          />
        </div>
        <div class="input-group">
          <label for="register-email" class="input-label">Email</label>
          <input
            type="email"
            id="register-email"
            name="register-email"
            class="input-field"
            placeholder="example@mail.com"
            required
            pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$"
            aria-label="Email"
            autocomplete="off"
          />
          <span class="input-hint">Формат: test@email.com</span>
        </div>
        <div class="input-group">
          <label for="register-password" class="input-label">Пароль</label>
          <input
            type="password"
            id="register-password"
            name="register-password"
            class="input-field"
            placeholder="Пароль"
            required
            minlength="6"
            aria-label="Пароль"
            autocomplete="new-password"
          />
          <span class="input-hint">Минимум 6 символов</span>
        </div>
        <div class="input-group">
          <label for="register-password-repeat" class="input-label">Подтвердите пароль</label>
          <input
            type="password"
            id="register-password-repeat"
            name="register-password-repeat"
            class="input-field"
            placeholder="Повторите пароль"
            required
            minlength="6"
            aria-label="Подтвердите пароль"
            autocomplete="new-password"
          />
        </div>
        <div class="input-group">
          <label for="register-language" class="input-label">Основной язык</label>
          <select
            id="register-language"
            name="register-language"
            class="input-field"
            required
            aria-label="Основной язык"
          >
            <option value="">Выберите язык</option>
            <option value="ru">Русский</option>
            <option value="en">English</option>
          </select>
        </div>
        <div class="auth-actions">
          <button type="submit" class="btn primary" onclick="showEmailVerificationModal()" aria-label="Зарегистрироваться">Зарегистрироваться</button>
        </div>
        <div class="auth-links">
          <a href="index.html" class="link">Авторизоваться</a>
        </div>
      </form>
    </div>
  </div>
  <div id="modal-container"></div>
<script>
  function showEmailVerificationModal() {
    event.preventDefault();

    const email = document.getElementById('register-email').value;
    const login = document.getElementById('register-login').value;
    const password = document.getElementById('register-password').value;
    const passwordRepeat = document.getElementById('register-password-repeat').value;
    const language = document.getElementById('register-language').value;

    if (password !== passwordRepeat) {
      alert('Пароли не совпадают');
      return;
    }

    if (!language) {
      alert('Выберите язык');
      return;
    }

    const userData = {
      email: email,
      login: login,
      password: password,
      language: language
    };

    fetch('api/register.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        fetch('email-verification.html')
          .then(response => response.text())
          .then(html => {
            document.getElementById('modal-container').innerHTML = html;
            const emailParam = new URLSearchParams(window.location.search);
            emailParam.set('email', email);
            history.replaceState(null, '', `${window.location.pathname}?${emailParam}`);

            const closeBtn = document.querySelector('#modal-container .modal-close-btn');
            if (closeBtn) {
              closeBtn.addEventListener('click', function() {
                document.getElementById('modal-container').innerHTML = '';
                history.replaceState(null, '', window.location.pathname);
              });
            }
          });
      } else {
        alert(data.message || 'Ошибка при регистрации');
      }
    })
    .catch(error => {
      console.error('Ошибка:', error);
      alert('Произошла ошибка при регистрации');
    });
  }
</script>
</body>
</html>